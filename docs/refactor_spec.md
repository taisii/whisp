# リファクタリング確定仕様（2026-02-10）

## 1. 背景
- 現状は責務集中が進み、変更時の影響範囲が広い。
- 特に `WhispApp` の一部ファイルに処理が集中し、保守性が低下している。
- いまのフェーズでは後方互換性の維持は不要であり、不要コードを残さない構成に刷新する。

## 2. 達成したいこと
- 最優先は保守性向上（責務分離）。
- プロダクト全体（アプリ本体、Core境界、スクリプト、ドキュメント）を対象に構造を再整理する。
- 将来の provider 追加・削除を、局所変更で完結できる状態にする。
- Debug 機能の信頼性を本体と同等に維持する。
- 性能は現状から劣化させない。

## 3. ユースケース

### UC1: パイプラインの一部を変更する
- 前提条件: 開発者が録音/STT/後処理/出力のいずれかを修正したい。
- 操作: 該当責務のモジュールのみ編集する。
- 期待結果: 他責務への修正波及なしで変更が完了する。

### UC2: provider を追加する
- 前提条件: 新しい LLM または STT provider を導入したい。
- 操作: provider 実装を追加し、登録箇所を更新する。
- 期待結果: 既存 provider 実装の改変最小で機能追加できる。

### UC3: provider を削除する
- 前提条件: 不要な provider を廃止したい。
- 操作: 対象 provider 実装と登録を削除する。
- 期待結果: 互換コードを残さず削除でき、他 provider は正常動作する。

### UC4: Debug 機能を使って品質確認する
- 前提条件: 録音ログ/正解データ/プロンプト記録で検証したい。
- 操作: Debug 画面・保存データを使って確認する。
- 期待結果: リファクタ後も同等の検証フローを継続できる。

## 4. 仕様詳細

### 4.1 全体方針
- リファクタリング対象範囲は全体（`WhispApp`、`WhispCore`、`scripts`、`docs`）。
- 1 PR で完了させる。
- 旧構造は併存させず、移行コードなしで即削除する。

### 4.2 責務分離
- `AppCoordinator` は状態遷移とオーケストレーション責務のみに限定する。
- パイプライン責務は以下単位で分離する。
  - `RecordingService`
  - `STTService`
  - `PostProcessService`
  - `OutputService`
  - `DebugCaptureService`

### 4.3 provider の拡張性
- provider 実装は共通インターフェースで統一する。
- 追加・削除は provider 実装単位で完結できる構造にする。
- provider 固有分岐の散在を禁止し、選択は集中管理する。

### 4.4 Core/App 境界
- `WhispCore` から `AppKit` 依存を排除する。
- UI/OS 依存処理は `WhispApp` 側に配置する。

### 4.5 エラー処理
- ユーザー向け通知と内部ログを明確に分離する。
- 同一エラーの表示文言は一貫化する。
- 内部ログはデバッグ可能性を維持し、UI文言に内部情報を漏らさない。

### 4.6 並行処理
- UI境界のみ `@MainActor` とする。
- 処理系は actor または非同期サービスに分離し、UIスレッド依存を避ける。

### 4.7 テストと品質
- 既存 Core テストはすべて通過させる。
- App 層に状態遷移テストを追加する。
- Debug 機能は本体同等優先度で回帰を許容しない。
- 性能は現状比で劣化禁止とし、既存ベンチマークで確認する。

### 4.8 ドキュメント
- 新構成に合わせて開発者向けドキュメントを更新する。
- 完了条件にドキュメント更新を含める。

## 5. スコープ外
- 新機能追加（既存要件を超えるUX変更や新規機能）。
- 後方互換性維持のための分岐・アダプタ追加。
- 性能改善そのものを主目的とした別施策（今回は劣化防止まで）。

## 6. 完了条件
- `AppCoordinator` が状態遷移/オーケストレーション中心の責務に整理されている。
- パイプライン責務が5サービスに分離されている。
- provider の追加・削除が局所変更で可能な構造になっている。
- `WhispCore` に `AppKit` 依存が存在しない。
- 旧構造と重複する不要コードが削除されている。
- Core テストが全件成功している。
- App 層の状態遷移テストが追加され、成功している。
- Debug 機能の主要フローが維持されている。
- 既存ベンチマークで性能劣化がない。
- ドキュメント更新が完了している。

## 7. 意思決定ログ（ユーザー合意）
- Q1: A（保守性最優先）
- Q2: C（全体対象）
- Q3: **Cを採用**（初回で `AppCoordinator`/provider分離/`DebugView` 分離まで完了）
- Q4: A（`AppCoordinator`責務限定）
- Q5: A（5サービス分割）
- Q6: **共通インターフェース方式を採用**（追加・削除容易性を最優先）
- Q7: A（CoreからAppKit依存排除）
- Q8: **Aを採用**（ユーザー向け通知と内部ログ分離）
- Q9: A（UI境界のみ `@MainActor`）
- Q10: A（Debug本体同等優先）
- Q11: B（App層状態遷移テスト追加）
- Q12: A（性能劣化禁止）
- Q13: C（一括PR）
- Q14: A（旧構造即削除）
- Q15: C（テスト/ベンチ/ドキュメント更新を完了条件化）
