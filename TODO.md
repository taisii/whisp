# Whisp TODO

## 問題分析と改善計画

### 1. 最初の文節がカットされる問題

**現象**: 録音開始直後の発話が認識されない、または途切れる

**原因の候補**:
1. **Deepgram接続遅延**: WebSocket接続確立までに0.5-1秒かかり、その間の音声が失われる
2. **音声バッファリング**: CPALの音声キャプチャ開始と実際のストリーミング開始のタイミングずれ
3. **LLM後処理**: Geminiが最初の文節を不要と判断してカットしている可能性

**調査項目**:
- [ ] Deepgram WebSocket接続完了までの時間を計測
- [ ] 録音開始から最初のSTT結果までのタイムラインをログ出力
- [ ] LLM後処理前後のテキストを比較して、カットが発生しているか確認

**改善案**:
- [ ] WebSocket接続を事前に確立しておく（プリコネクション）
- [ ] 録音開始時に短いバッファを設けて、接続完了後に送信
- [ ] プロンプトに「最初の文節を削除しない」指示を追加
- [ ] 開始音を鳴らしてからユーザーに話し始めてもらう運用ガイド

---

### 2. クリップボード汚染問題

**現象**: ペースト操作をすると直前の音声入力結果が入る

**現在の実装**:
- `org.nspasteboard.TransientType` マーカーを設定（履歴アプリ回避用）
- `auto_paste` 有効時: クリップボードに書き込み → Cmd+V送信

**問題の本質**:
`TransientType`マーカーはクリップボード履歴アプリ（Alfred、Paste等）向けの回避策であり、実際のクリップボード内容は上書きされる。ユーザーが次にCmd+Vを押すと、音声入力結果がペーストされる。

**改善案**:
- [ ] **Option A: クリップボード復元方式**
  1. 音声入力前のクリップボード内容を保存
  2. 音声入力結果をペースト
  3. 元のクリップボード内容を復元（遅延復元）

- [ ] **Option B: 直接入力方式（クリップボード非使用）**
  - `enigo`や`CGEvent`で直接テキストを入力
  - クリップボードを一切使用しない
  - 制限: 日本語入力の場合、IME状態に依存する可能性

- [ ] **Option C: 設定で選択可能に**
  - 「クリップボードを復元する」オプションを追加

**推奨**: Option A（クリップボード復元）+ Option C（設定化）

---

### 3. 録音開始/終了音が鳴らない問題

**現在の実装** (`src-tauri/src/sound.rs`):
- `/System/Library/Sounds/Tink.aiff` を rodio で再生
- エラーはすべて無視される（サイレント失敗）

**問題点**:
1. エラーログがないため、失敗原因を特定できない
2. ファイル存在確認がない
3. オーディオ出力デバイスの状態に依存

**テスト方法**:
```bash
# システム音ファイルの存在確認
ls -la /System/Library/Sounds/Tink.aiff

# afplayで手動再生テスト
afplay /System/Library/Sounds/Tink.aiff

# Rustテスト（新規作成が必要）
cd src-tauri && cargo test sound --nocapture
```

**改善案**:
- [ ] エラーをログ出力するように変更
- [ ] アプリにバンドルした音声ファイルを使用（システム依存排除）
- [ ] 設定で音のON/OFFを切り替え可能に
- [ ] 音が再生されたかを確認するテストを追加

---

### 4. 録音方式の変更（PTT → Toggle）

**現在の状態**:
- コードではデフォルト `RecordingMode::Toggle`
- ユーザーの `config.toml` で `PushToTalk` が設定されている可能性

**確認方法**:
```bash
cat ~/.config/whisp/config.toml | grep recording_mode
```

**対応**:
- [ ] `config.toml` の `recording_mode` を `toggle` に変更
- [ ] UIで録音モードを切り替える機能を追加（将来）

---

## 仕様明確化

### 録音フロー（目標仕様）

```
[待機状態]
    │
    ├─ ショートカット押下 (Cmd+J)
    │
    ▼
[録音準備]
    │
    ├─ Deepgram WebSocket事前接続（可能なら）
    ├─ 開始音再生
    │
    ▼
[録音中]
    │
    ├─ 音声をリアルタイムでDeepgramへストリーム
    ├─ メニューバーアイコン: 赤色
    │
    ├─ ショートカット押下 (Cmd+J)
    │
    ▼
[処理中]
    │
    ├─ STT結果確定
    ├─ LLM後処理（Gemini/GPT）
    ├─ 元のクリップボード保存 ← NEW
    ├─ 結果をクリップボードへ
    ├─ auto_paste時: Cmd+V送信
    ├─ 元のクリップボード復元 ← NEW
    ├─ 完了音再生
    │
    ▼
[待機状態]
```

### クリップボード動作仕様（目標）

| 設定 | 動作 |
|------|------|
| `auto_paste: true, restore_clipboard: true` | ペースト後、元のクリップボードを復元 |
| `auto_paste: true, restore_clipboard: false` | ペースト後、クリップボードは音声入力結果のまま |
| `auto_paste: false` | クリップボードに書き込むのみ |

### 音声フィードバック仕様（目標）

| タイミング | 音 | 設定 |
|------------|-----|------|
| 録音開始 | 短いクリック音 | `sound_feedback: true` |
| 録音終了/処理完了 | 完了音 | `sound_feedback: true` |
| エラー発生 | エラー音（別の音） | `sound_feedback: true` |

---

## 優先順位

1. **High**: クリップボード復元機能の実装
2. **High**: 録音開始/終了音の修正とテスト追加
3. **Medium**: 最初の文節カット問題の調査と改善
4. **Low**: UIでの録音モード切り替え

---

## 関連ファイル

- `src-tauri/src/lib.rs` - メインロジック、録音制御
- `src-tauri/src/clipboard.rs` - クリップボード操作
- `src-tauri/src/sound.rs` - 音声フィードバック
- `src-tauri/src/config.rs` - 設定管理
- `src-tauri/src/post_processor.rs` - LLM後処理
